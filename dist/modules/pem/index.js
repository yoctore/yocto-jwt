/* yocto-jwt - Manage jwt token, and encrypt/decrypt all request based on jwt webtoken and cert - V3.0.1 */

"use strict";var lockFile=require("lockfile"),pem=require("pem"),Q=require("q"),_=require("lodash"),fs=require("fs"),path=require("path");function Pem(){this.state=!1}Pem.prototype.processJwt=function(){var e=Q.defer();return pem.createCertificate({days:1,selfSigned:!0},function(t,r){var i={};if(t)e.reject(t);else{var s=path.normalize(process.cwd()+"/cert-jwt.tmp"),o=path.normalize(process.cwd()+"/cert-jwt.lock");lockFile.lock(o,function(t){var o=function(t,s){if(t)return e.reject(t);r=_.isUndefined(s)?r:JSON.parse(s),_.merge(i,r),pem.getPublicKey(r.certificate,function(t,r){t?e.reject(t):(_.merge(i,r),this.state=!0,e.resolve(i))}.bind(this))}.bind(this);t?fs.readFile(s,o):fs.writeFile(s,JSON.stringify(r),o)}.bind(this))}}.bind(this)),e.promise},Pem.prototype.verify=function(e,t){var r=Q.defer();return pem.getModulus(e,function(e,i){e?r.reject(e):pem.getModulus(t,function(e,t){e||i.modulus!==t.modulus?r.reject(e||"certificate not match with given key"):r.resolve()})}),r.promise},Pem.prototype.isReady=function(){return this.state},module.exports=new Pem;