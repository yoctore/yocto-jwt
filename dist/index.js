/* yocto-jwt - Manage jwt token, and encrypt/decrypt all request based on jwt webtoken and cert - V3.0.0 */

"use strict";var logger=require("yocto-logger"),uuid=require("uuid"),fs=require("fs"),path=require("path"),jwt=require("jsonwebtoken"),_=require("lodash"),Q=require("q"),utils=require("yocto-utils"),crypto=require("crypto"),pem=require("./modules/pem"),Netmask=require("netmask").Netmask;function Jswt(t){this.logger=t,this.encryptKey="",this.secureKeys={publicKey:"",clientKey:"",certificate:"",serviceKey:"",csr:""},this.algorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],this.usedAlgorithm="HS256",this.headers={access:"x-jwt-access-token",encode:"x-jwt-decode-token"},this.ips=["1","::1","127.0.0.1"],this.allowedRoutes=[]}Jswt.prototype.load=function(){var t=Q.defer();return pem.processJwt().then(function(e){_.merge(this.secureKeys,e),t.resolve()}.bind(this)).catch(function(e){t.reject(e)}),t.promise},Jswt.prototype.getKey=function(){return this.encryptKey},Jswt.prototype.getPrivateKey=function(){return this.secureKeys.clientKey},Jswt.prototype.getPublicKey=function(){return this.secureKeys.publicKey},Jswt.prototype.getAccessKey=function(){if(!this.isReady())return this.logger.error(["[ Jswt.getAccessKey ] -","Cannot get access key. Encrypt key is not set"].join(" ")),!1;if(!pem.isReady())return this.logger.error(["[ Jswt.getAccessKey ] -","Cannot get access key. Certificate was not genrated."].join(" ")),!1;var t=crypto.createHash("sha1").update(this.getPublicKey()).digest("hex");return utils.crypto.encrypt(t,this.getPublicKey())},Jswt.prototype.generateAccessToken=function(t){if(!this.isReady())return this.logger.error(["[ Jswt.generateAccessToken ] -","Cannot generate access token. Encrypt key is not set"].join(" ")),!1;if(!pem.isReady())return this.logger.error(["[ Jswt.generateAccessToken ] -","Cannot generate access token. Certificate was not genrated."].join(" ")),!1;var e=this.getAccessKey(),r=(t=_.isString(t)&&!_.isEmpty(t)?t:uuid.v4())===e?"1h":"5m";return this.sign({name:t,date:Date.now(),key:e},{expiresIn:r})},Jswt.prototype.allowedIps=function(t){this.ips=_.uniq(_.flatten([this.ips,_.isArray(t)?t:[t]]))},Jswt.prototype.addAllowedRoutes=function(t){this.allowedRoutes=_.uniq(_.flatten([this.allowedRoutes,_.isArray(t)?t:[t]]))},Jswt.prototype.isAllowedRoutes=function(t){var e=!1;return _.every(this.allowedRoutes,function(r){try{if((r=_.isRegExp(r)?r:new RegExp(r)).test(t))return e=!0,this.logger.debug("[ Jswt.isAllowedRoutes ] - the url "+t+" was authorized to connect without jwt validation with patern : "+r),!1}catch(t){return!1}return!0}.bind(this)),e},Jswt.prototype.ipIsAllowed=function(t){t=_.trimStart(t,"::ffff:");var e=/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}(\/[0-9]{1,2})$/,r=!1;return _.every(this.ips,function(s){if(!(r="*"===s)&&e.test(s))try{var i=new Netmask(s);r=i.contains(t)}catch(e){this.logger.error(["[ Jswt.ipIsAllowed ] - ",t,"Netmask error :",e].join(" "))}else r=_.includes(this.ips,t)||"*"===s;return!r}.bind(this)),r},Jswt.prototype.isAuthorized=function(){return function(t,e,r){if(!_.isObject(t)||!_.isObject(e))return r();var s=t.headers["x-forwarded-for"]||t.connection.remoteAddress;this.logger.debug("[ Jswt.isAuthorized ] - a new request incoming into url : "+t.url+" - from IP : "+s);var i=this.isAllowedRoutes(t.url);if(!i&&!this.ipIsAllowed(s))return this.logger.error("[ Jswt.isAuthorized ] - request to url : "+t.url+" is NOT allowed for IP : "+s),e.status(403).send("You are not allowed to access to this ressource.").end();var o=t.get(this.headers.access.toLowerCase());if(_.isUndefined(o))return i?r():(this.logger.error("[ Jswt.isAuthorized ] - request to url : "+t.url+" for IP : "+s+" try to access route but is not an allowed routes and is not and have no request token"),e.status(403).send("You are not allowed to access to this ressource.").end());this.verify(o).then(function(s){if(!t.is("application/json"))return this.logger.debug("[ Jswt.isAuthorized ] - valid token, but not application/json"),r();var i=crypto.createHash("sha1").update(this.getPublicKey()).digest("hex");if(!1===utils.crypto.decrypt(i,s.key.toString()))return e.status(403).send("Invalid Token BBB.");pem.verify(this.secureKeys.certificate,this.secureKeys.clientKey).then(function(){return this.logger.debug("[ Jswt.isAuthorized ] - given token seems to be valid"),r()}.bind(this)).catch(function(t){return this.logger.error(["[ Jswt.isAuthorized ] - ",t].join(" ")),e.status(403).send("Invalid Token AAAA.")}.bind(this))}.bind(this)).catch(function(t){return _.has(t,"expiredAt")?e.status(403).send("Token has expired."):e.status(403).send(["Cannot validate your access.","Please retry."].join(" ")).end()})}.bind(this)},Jswt.prototype.autoEncryptRequest=function(){return function(t,e,r){if(_.isObject(t)&&_.isObject(e)){_.forEach(["json","jsonp"],function(t){var r=e[t],s=this;e[t]=function(t){return s.logger.debug(["[ Jswt.autoEncryptRequest ] - Receiving new data to encrypt : ",utils.obj.inspect(t)].join(" ")),r.call(this,[s.sign(t)])}}.bind(this))}return r()}.bind(this)},Jswt.prototype.autoDecryptRequest=function(){return function(t,e,r){if(!t.is("application/json"))return r();this.logger.debug(["[ Jswt.autoDecryptRequest ] - Receiving new data to decrypt : ",utils.obj.inspect(t.body)].join(" "));var s=t.body;if(_.isEmpty(s))return r();1===t.body.length&&_.first(t.body)&&!_.isEmpty(_.first(t.body))&&(s=_.first(t.body)),this.verify(s).then(function(e){t.body=this.removeJwtKey(e),r()}.bind(this)).catch(function(t){return this.logger.error(["[ Jswt.autoDecryptRequest ] -",t].join(" ")),e.status(403).send("You d'ont have access to this ressource.").end()}.bind(this))}.bind(this)},Jswt.prototype.algorithm=function(t){return _.isUndefined(t)||_.isNull(t)||(_.isString(t)&&_.includes(this.algorithms,t)?(this.usedAlgorithm=t,this.logger.info(["[ Jswt.algorithm ] - set algorithm to",t].join(" "))):this.logger.warning(["[ Jswt.algorithm ] - invalid algorithm given. Keep algorithm to",this.usedAlgorithm].join(" "))),this.usedAlgorithm},Jswt.prototype.setKey=function(t){var e=!1;if(_.isString(t)&&!_.isEmpty(t)){var r=t;path.isAbsolute(t)||(t=path.normalize([process.cwd(),t].join("/")));try{e=fs.statSync(t).isFile()}catch(t){this.logger.warning("[ Jswt.setKey ] - key is not a file. Process key like a string.")}return e&&(t=fs.readFileSync(t)),this.encryptKey=e?t:r,this.logger.info("[ Jswt.setKey ] - Setting key done."),_.isString(this.encryptKey)&&!_.isEmpty(this.encryptKey)}return this.logger.warning("[ Jswt.setKey ] - Invalid key or path given."),!1},Jswt.prototype.setPrivateKey=function(t){return!_.isString(t)&&!_.isEmpty(t)&&(this.privateKey=t,!0)},Jswt.prototype.verify=function(t,e){var r=Q.defer();this.isReady()||(this.logger.error("[ Jswt.verify ] - Cannot sign your data. Encrypt key is not set"),r.reject("[ Jswt.verify ] - Cannot sign your data. Encrypt key is not set"));try{jwt.verify(t,this.encryptKey,function(t,s){t?(this.logger.error(["[ Jswt.verify ] - An error occured :",t.message,t.expiredAt||""].join(" ")),r.reject(t)):(_.isBoolean(e)&&e&&(s=this.removeJwtKey(s)),r.resolve(s))}.bind(this))}catch(t){this.logger.error(["[ Jswt.verify ] - Cannot cerify your data :",t].join(" ")),r.reject("Cannot certify your data.")}return r.promise},Jswt.prototype.isReady=function(){return _.isString(this.encryptKey)&&!_.isEmpty(this.encryptKey)},Jswt.prototype.sign=function(t,e){return this.isReady()?(e=e||{},_.has(e,"algorithm")&&(_.includes(this.algorithms,e.algorithm)?this.logger.info(["[ Jswt.sign ] - custom valid algorithm given in options.","Use",e.algorithm,"for encryption"].join(" ")):_.merge(e,{algorithm:this.algorithm()})),jwt.sign(t,this.encryptKey,e)):(this.logger.error("[ Jswt.sign ] - Cannot sign your data. Encrypt key is not set"),!1)},Jswt.prototype.removeJwtKey=function(t){if(_.isObject(t)&&!_.isEmpty(t)&&!_.isArray(t)){return _.omit(t,["iss","sub","aud","exp","nbf","iat","jti"])}return t},Jswt.prototype.decode=function(t,e){if(!this.isReady())return this.logger.error("[ Jswt.decode ] - Cannot sign your data. Encrypt key is not set"),!1;var r=jwt.decode(t);return _.isBoolean(e)&&e&&(r=this.removeJwtKey(r)),r},module.exports=function(t){return(_.isUndefined(t)||_.isNull(t))&&(logger.warning("[ Jswt.constructor ] - Invalid logger given. Use internal logger"),t=logger),new Jswt(t)};